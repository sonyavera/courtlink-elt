name: Data Ingestion

on:
  schedule:
    # Run every 45 minutes: all jobs except podplay-members
    - cron: "*/45 * * * *"
    # Run every 6 hours: podplay-members
    - cron: "0 */6 * * *"
  workflow_dispatch: # Allow manual triggering
    inputs:
      job_to_run:
        description: "Which job(s) to run"
        required: true
        type: choice
        options:
          - "45min"
          - "6hour"
          - "all"
        default: "all"

jobs:
  ingest-45min:
    name: Ingest All (45 min schedule - excludes podplay-members)
    runs-on: ubuntu-latest
    environment: prod
    if: github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && (github.event.inputs.job_to_run == '45min' || github.event.inputs.job_to_run == 'all'))

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python3 -m pip install --upgrade pip
          pip install -r requirements/all.txt

      - name: Ingest CourtReserve Events
        run: make ingest-courtreserve-events
        env:
          PG_DSN: ${{ secrets.PG_DSN }}
          PG_SCHEMA: ${{ secrets.PG_SCHEMA }}
          PKLYN_USERNAME: ${{ secrets.PKLYN_USERNAME }}
          PKLYN_PASSWORD: ${{ secrets.PKLYN_PASSWORD }}
          GOTHAM_API_KEY: ${{ secrets.GOTHAM_API_KEY }}

      - name: Ingest Podplay Events
        run: make ingest-podplay-events
        env:
          PG_DSN: ${{ secrets.PG_DSN }}
          PG_SCHEMA: ${{ secrets.PG_SCHEMA }}
          PKLYN_USERNAME: ${{ secrets.PKLYN_USERNAME }}
          PKLYN_PASSWORD: ${{ secrets.PKLYN_PASSWORD }}
          GOTHAM_API_KEY: ${{ secrets.GOTHAM_API_KEY }}

      - name: Ingest Podplay Court Availability
        run: make ingest-podplay-court-availability
        env:
          PG_DSN: ${{ secrets.PG_DSN }}
          PG_SCHEMA: ${{ secrets.PG_SCHEMA }}
          PKLYN_USERNAME: ${{ secrets.PKLYN_USERNAME }}
          PKLYN_PASSWORD: ${{ secrets.PKLYN_PASSWORD }}
          GOTHAM_API_KEY: ${{ secrets.GOTHAM_API_KEY }}

      - name: Ingest CourtReserve Reservations
        run: make ingest-courtreserve-reservations
        env:
          PG_DSN: ${{ secrets.PG_DSN }}
          PG_SCHEMA: ${{ secrets.PG_SCHEMA }}
          PKLYN_USERNAME: ${{ secrets.PKLYN_USERNAME }}
          PKLYN_PASSWORD: ${{ secrets.PKLYN_PASSWORD }}
          GOTHAM_API_KEY: ${{ secrets.GOTHAM_API_KEY }}

      - name: Ingest CourtReserve Members
        run: make ingest-courtreserve-members
        env:
          PG_DSN: ${{ secrets.PG_DSN }}
          PG_SCHEMA: ${{ secrets.PG_SCHEMA }}
          PKLYN_USERNAME: ${{ secrets.PKLYN_USERNAME }}
          PKLYN_PASSWORD: ${{ secrets.PKLYN_PASSWORD }}
          GOTHAM_API_KEY: ${{ secrets.GOTHAM_API_KEY }}

      - name: Ingest Podplay Reservations
        run: make ingest-podplay-reservations
        env:
          PG_DSN: ${{ secrets.PG_DSN }}
          PG_SCHEMA: ${{ secrets.PG_SCHEMA }}
          PKLYN_USERNAME: ${{ secrets.PKLYN_USERNAME }}
          PKLYN_PASSWORD: ${{ secrets.PKLYN_PASSWORD }}
          GOTHAM_API_KEY: ${{ secrets.GOTHAM_API_KEY }}

      - name: Install dbt package dependencies
        run: python3 -m scripts.run_dbt deps
        env:
          PG_SCHEMA: ${{ secrets.PG_SCHEMA }}
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          DB_PORT: ${{ secrets.DB_PORT }}
          DB_NAME: ${{ secrets.DB_NAME }}

      - name: Run dbt
        run: python3 -m scripts.run_dbt run --target prod
        env:
          PG_SCHEMA: ${{ secrets.PG_SCHEMA }}
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          DB_PORT: ${{ secrets.DB_PORT }}
          DB_NAME: ${{ secrets.DB_NAME }}

  ingest-podplay-members:
    name: Ingest Podplay Members (6 hour schedule)
    runs-on: ubuntu-latest
    environment: prod
    if: |
      (github.event_name == 'schedule') ||
      (github.event_name == 'workflow_dispatch' && (github.event.inputs.job_to_run == '6hour' || github.event.inputs.job_to_run == 'all'))

    # Only run if the current hour is divisible by 6 (0, 6, 12, 18)
    # This ensures it only runs on the 6-hour schedule, not every 30 minutes
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Check if should run (6 hour boundary)
        id: check-time
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
          else
            HOUR=$(date -u +%H)
            if [ $((HOUR % 6)) -eq 0 ]; then
              echo "should_run=true" >> $GITHUB_OUTPUT
            else
              echo "should_run=false" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Install dependencies
        if: steps.check-time.outputs.should_run == 'true'
        run: |
          python3 -m pip install --upgrade pip
          pip install -r requirements/all.txt

      - name: Ingest Podplay Members
        if: steps.check-time.outputs.should_run == 'true'
        run: make ingest-podplay-members
        env:
          PG_DSN: ${{ secrets.PG_DSN }}
          PG_SCHEMA: ${{ secrets.PG_SCHEMA }}
          PKLYN_USERNAME: ${{ secrets.PKLYN_USERNAME }}
          PKLYN_PASSWORD: ${{ secrets.PKLYN_PASSWORD }}
          GOTHAM_API_KEY: ${{ secrets.GOTHAM_API_KEY }}

      - name: Install dbt package dependencies
        if: steps.check-time.outputs.should_run == 'true'
        run: python3 -m scripts.run_dbt deps
        env:
          PG_SCHEMA: ${{ secrets.PG_SCHEMA }}
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          DB_PORT: ${{ secrets.DB_PORT }}
          DB_NAME: ${{ secrets.DB_NAME }}

      - name: Run dbt
        if: steps.check-time.outputs.should_run == 'true'
        run: python3 -m scripts.run_dbt run --target prod
        env:
          PG_SCHEMA: ${{ secrets.PG_SCHEMA }}
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          DB_PORT: ${{ secrets.DB_PORT }}
          DB_NAME: ${{ secrets.DB_NAME }}
