name: Data Ingestion

on:
  schedule:
    # Run every 2 hours between 9am EST (14:00 UTC) and 12am EST (05:00 UTC): all jobs including podplay-members (incremental)
    # Runs at: 14,16,18,20,22,0,2,4 UTC (9am,11am,1pm,3pm,5pm,7pm,9pm,11pm EST)
    - cron: "0 14,16,18,20,22,0,2,4 * * *"
    # Run daily at 2am UTC: podplay-members full refresh
    - cron: "0 2 * * *"
    # Run daily at 8am EST (13:00 UTC): staging ingestion
    - cron: "0 13 * * *"
    # Run weekly on Monday at 2am UTC: Google reviews
    - cron: "0 2 * * 1"
  workflow_dispatch: # Allow manual triggering
    inputs:
      job_to_run:
        description: "Which job(s) to run"
        required: true
        type: choice
        options:
          - "2hour"
          - "daily_full"
          - "daily_staging"
          - "google_reviews"
          - "all"
        default: "all"

jobs:
  ingest-2hour:
    name: Ingest All (Every 2 hours, 9am-12am EST)
    runs-on: ubuntu-latest
    environment: prod
    if: github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && (github.event.inputs.job_to_run == '2hour' || github.event.inputs.job_to_run == 'all'))
    env:
      PG_DSN: ${{ secrets.PG_DSN }}
      PG_SCHEMA: ${{ secrets.PG_SCHEMA }}
      PKLYN_USERNAME: ${{ secrets.PKLYN_USERNAME }}
      PKLYN_PASSWORD: ${{ secrets.PKLYN_PASSWORD }}
      GOTHAM_API_KEY: ${{ secrets.GOTHAM_API_KEY }}
      DB_HOST: ${{ secrets.DB_HOST }}
      DB_USER: ${{ secrets.DB_USER }}
      DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
      DB_PORT: ${{ secrets.DB_PORT }}
      DB_NAME: ${{ secrets.DB_NAME }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Check if should run (every 2 hours between 9am EST and 12am EST)
        id: check-time
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
          else
            HOUR=$(date -u +%H)
            # Run at 14,16,18,20,22,0,2,4 UTC (9am,11am,1pm,3pm,5pm,7pm,9pm,11pm EST)
            # Stop at 12am EST (05:00 UTC), resume at 9am EST (14:00 UTC)
            if [[ "$HOUR" =~ ^(14|16|18|20|22|0|2|4)$ ]]; then
              echo "should_run=true" >> $GITHUB_OUTPUT
            else
              echo "should_run=false" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Install dependencies
        if: steps.check-time.outputs.should_run == 'true'
        run: |
          python3 -m pip install --upgrade pip
          pip install -r requirements/all.txt

      - name: Ingest CourtReserve Events
        if: steps.check-time.outputs.should_run == 'true'
        run: make ingest-courtreserve-events

      - name: Ingest Podplay Events
        if: steps.check-time.outputs.should_run == 'true'
        run: make ingest-podplay-events

      - name: Ingest Podplay Court Availability
        if: steps.check-time.outputs.should_run == 'true'
        run: make ingest-podplay-court-availability

      - name: Ingest CourtReserve Court Availability
        if: steps.check-time.outputs.should_run == 'true'
        run: make ingest-courtreserve-court-availability

      - name: Ingest CourtReserve Reservations
        if: steps.check-time.outputs.should_run == 'true'
        run: make ingest-courtreserve-reservations

      - name: Ingest CourtReserve Members
        if: steps.check-time.outputs.should_run == 'true'
        run: make ingest-courtreserve-members

      - name: Ingest Podplay Reservations
        if: steps.check-time.outputs.should_run == 'true'
        run: make ingest-podplay-reservations

      - name: Ingest Podplay Members (Incremental)
        if: steps.check-time.outputs.should_run == 'true'
        run: make ingest-podplay-members
        env:
          PODPLAY_MEMBERS_INCREMENTAL: "true"
          PODPLAY_MEMBERS_RECENT_MINUTES: "90"

      - name: Preprocess events (add skill levels)
        if: steps.check-time.outputs.should_run == 'true'
        run: make add-skill-levels

      - name: Install dbt package dependencies
        if: steps.check-time.outputs.should_run == 'true'
        run: python3 -m scripts.run_dbt deps

      - name: Run dbt
        if: steps.check-time.outputs.should_run == 'true'
        run: python3 -m scripts.run_dbt run --target prod

  ingest-google-reviews:
    name: Ingest Google Reviews (Weekly)
    runs-on: ubuntu-latest
    environment: prod
    if: |
      (github.event_name == 'schedule') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.job_to_run == 'google_reviews')
    env:
      PG_DSN: ${{ secrets.PG_DSN }}
      PG_SCHEMA: ${{ secrets.PG_SCHEMA }}
      GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
      DB_HOST: ${{ secrets.DB_HOST }}
      DB_USER: ${{ secrets.DB_USER }}
      DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
      DB_PORT: ${{ secrets.DB_PORT }}
      DB_NAME: ${{ secrets.DB_NAME }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Check if should run (Monday at 2am UTC)
        id: check-time
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
          else
            DAY=$(date -u +%u)  # 1 = Monday, 7 = Sunday
            HOUR=$(date -u +%H)
            if [ "$DAY" == "1" ] && [ "$HOUR" == "02" ]; then
              echo "should_run=true" >> $GITHUB_OUTPUT
            else
              echo "should_run=false" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Install dependencies
        if: steps.check-time.outputs.should_run == 'true'
        run: |
          python3 -m pip install --upgrade pip
          pip install -r requirements/all.txt

      - name: Ingest Google Reviews
        if: steps.check-time.outputs.should_run == 'true'
        run: make ingest-google-reviews

  ingest-podplay-members-full:
    name: Ingest Podplay Members (Daily Full Refresh)
    runs-on: ubuntu-latest
    environment: prod
    if: |
      (github.event_name == 'schedule') ||
      (github.event_name == 'workflow_dispatch' && (github.event.inputs.job_to_run == 'daily_full' || github.event.inputs.job_to_run == 'all'))
    env:
      PG_DSN: ${{ secrets.PG_DSN }}
      PG_SCHEMA: ${{ secrets.PG_SCHEMA }}
      GOTHAM_API_KEY: ${{ secrets.GOTHAM_API_KEY }}
      DB_HOST: ${{ secrets.DB_HOST }}
      DB_USER: ${{ secrets.DB_USER }}
      DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
      DB_PORT: ${{ secrets.DB_PORT }}
      DB_NAME: ${{ secrets.DB_NAME }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Check if should run (once daily at 2am UTC)
        id: check-time
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
          else
            HOUR=$(date -u +%H)
            if [ "$HOUR" == "02" ]; then
              echo "should_run=true" >> $GITHUB_OUTPUT
            else
              echo "should_run=false" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Install dependencies
        if: steps.check-time.outputs.should_run == 'true'
        run: |
          python3 -m pip install --upgrade pip
          pip install -r requirements/all.txt

      - name: Ingest Podplay Members (Full Refresh)
        if: steps.check-time.outputs.should_run == 'true'
        run: make ingest-podplay-members-full

      - name: Preprocess events (add skill levels)
        if: steps.check-time.outputs.should_run == 'true'
        run: make add-skill-levels

      - name: Install dbt package dependencies
        if: steps.check-time.outputs.should_run == 'true'
        run: python3 -m scripts.run_dbt deps

      - name: Run dbt
        if: steps.check-time.outputs.should_run == 'true'
        run: python3 -m scripts.run_dbt run --target prod

  ingest-staging:
    name: Ingest All to Staging (Daily at 8am EST)
    runs-on: ubuntu-latest
    environment: prod
    if: |
      (github.event_name == 'schedule') ||
      (github.event_name == 'workflow_dispatch' && (github.event.inputs.job_to_run == 'daily_staging' || github.event.inputs.job_to_run == 'all'))
    env:
      PG_DSN: ${{ secrets.PG_DSN }}
      PG_SCHEMA: ${{ secrets.PG_SCHEMA_STG }}
      PKLYN_USERNAME: ${{ secrets.PKLYN_USERNAME }}
      PKLYN_PASSWORD: ${{ secrets.PKLYN_PASSWORD }}
      GOTHAM_API_KEY: ${{ secrets.GOTHAM_API_KEY }}
      DB_HOST: ${{ secrets.DB_HOST }}
      DB_USER: ${{ secrets.DB_USER }}
      DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
      DB_PORT: ${{ secrets.DB_PORT }}
      DB_NAME: ${{ secrets.DB_NAME }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Check if should run (daily at 8am EST / 13:00 UTC)
        id: check-time
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
          else
            HOUR=$(date -u +%H)
            if [ "$HOUR" == "13" ]; then
              echo "should_run=true" >> $GITHUB_OUTPUT
            else
              echo "should_run=false" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Install dependencies
        if: steps.check-time.outputs.should_run == 'true'
        run: |
          python3 -m pip install --upgrade pip
          pip install -r requirements/all.txt

      - name: Run staging ingestion pipeline
        if: steps.check-time.outputs.should_run == 'true'
        run: make ingest-staging
        env:
          PG_SCHEMA_STG: ${{ secrets.PG_SCHEMA_STG }}
          PG_SCHEMA: ${{ secrets.PG_SCHEMA_STG }}
