# Alembic Migrations

This directory contains Alembic database migrations for the Courtlink ELT project.

## Setup

Alembic is configured to use environment variables:
- `PG_DSN` - PostgreSQL connection string (preferred)
- `DB_HOST`, `DB_USER`, `DB_PASSWORD`, `DB_PORT`, `DB_NAME` - Individual connection parameters (fallback)
- `PG_SCHEMA` - Target schema for migrations (required)

## Usage

### Makefile Commands

- `make migrate-upgrade` - Apply all pending migrations
- `make migrate-downgrade` - Rollback the last migration
- `make migrate-revision message="description"` - Create a new autogenerated migration
- `make migrate-history` - Show migration history
- `make migrate args="<alembic-args>"` - Run any alembic command

### Direct Alembic Commands

You can also use alembic directly:

```bash
# Apply all migrations
alembic upgrade head

# Rollback one migration
alembic downgrade -1

# Create a new migration (autogenerate from models)
alembic revision --autogenerate -m "description"

# Create an empty migration
alembic revision -m "description"

# Show current revision
alembic current

# Show migration history
alembic history
```

## Models

The SQLAlchemy models are defined in `migrations/models.py`. These models are used by Alembic for autogeneration of migrations.

## Migration Files

Migration files are stored in `alembic/versions/` and follow the naming pattern:
- `001_initial_schema.py` - Initial database schema
- `002_update_reservations.py` - Schema updates

Each migration file contains:
- `upgrade()` - Function to apply the migration
- `downgrade()` - Function to rollback the migration

## Notes

- The schema is set dynamically from the `PG_SCHEMA` environment variable
- Migrations are applied to the schema specified in `PG_SCHEMA`
- The alembic version table is stored in the same schema

